!function(){function a(a,b){this.constructor.prototype.__proto__=Error.prototype,Error.call(this),Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.message=a,this.indexOfMarkupErrorChar=b}function b(){return(new Date).getTime()}root.hkml=function(a){return new d(a)};var c={TOKEN_KEY:"str",TOKEN_OR:"or",TOKEN_SEQ:"seq",SEQ:">",COMB:"+",SPACE:" ",TAB:"	",createToken:function(a,b,c){return{name:a,value:b,index:c}},compile:function(a){var b=c.tokenize(a),d=c.buildKeysNodes(b);return new e(a,d)},tokenize:function(b){var d,e,f="",g=[];for(d=0;d<b.length;d++)switch(e=b[d]){case c.SEQ:for(e=b[++d],f="";e!=c.SEQ;){if(d==b.length)throw new a("Unexpected end of line. Expected '>'",d-1);f+=e,e=b[++d]}if(0!=f.length){if(isNaN(parseInt(f))||parseInt(f)<=0)throw new a("Wrong delay value '"+f+"'",d-f.length-1)}else f="0";g.push(c.createToken(c.TOKEN_SEQ,f,d-f.length-1));break;case c.COMB:g.push(c.createToken(c.TOKEN_OR,e,d));break;case c.TAB:case c.SPACE:break;default:f="";do f+=e,e=b[++d];while(e!=c.SEQ&&e!=c.COMB&&e!=c.SPACE&&e!=c.TAB&&d!=b.length);g.push(c.createToken(c.TOKEN_KEY,f,d)),d--}},buildKeysNodes:function(b){for(var d,e,f,g,h=[],i=[],j=0,k=null,l=0;l<b.length;l++){if(d=b[l],e=d.name,f=d.value,g=d.index,0==l&&(e==c.TOKEN_OR||e==c.TOKEN_SEQ))throw new a("Line must be started by key",g);if(l==b.length-1&&(e==c.TOKEN_OR||e==c.TOKEN_SEQ))throw new a("Line must be ended by key",g);switch(e){case c.TOKEN_KEY:i.push(f);break;default:var m=parseFloat(f),n=0!=m&&!isNaN(m);if(null==k)n?(h.push(c.createKeysNode(i,e,j,d.index)),i=[],j=m):k=e;else if(k!=e||n){if(e==c.TOKEN_OR&&i.length>1){var o=i.pop();h.push(c.createKeysNode(i,k,j,d.index)),i=[o]}else h.push(c.createKeysNode(i,k,j,d.index)),i=[];j=m,k=n?null:e}else k=e}}return 0!=i.length&&h.push(c.createKeysNode(i,k,j,d.index)),h},createKeysNode:function(b,d,e,h){for(var i,j=new Array(b.length),k=0;k<b.length;k++){if(i=b[k],void 0==f[i])throw new a("Unknown key alias '"+i+"'",h);j[k]=f[i]}return new g(j,e,d==c.TOKEN_OR)}},d=function(a){this._eventsTarget=a||root,this._virtualMachines={},this.startKeyboardEventListening()};d.prototype.startKeyboardEventListening=function(){var a=this;this._eventsTargetCallback=function(b){a.onKeyDown(b)},this._eventsTarget.addEventListener("keydown",this._eventsTargetCallback)},d.prototype.onKeyDown=function(a){for(var b in this._virtualMachines){var c=this._virtualMachines[b],d=c.vm,e=c.callback;d.checkPressedKey(a.keyCode)?d.finished&&(d.reset(),e&&e(d.markup,!0)):(d.reset(),e&&e(d.markup,!1))}},d.prototype.on=function(a,b){if(this._virtualMachines[a])throw new Error("Handler for '"+a+"' already exist");this._virtualMachines[a]={vm:c.compile(a),callback:b}},d.prototype.remove=function(a){if(!this._virtualMachines[a])throw new Error("Handler for '"+a+"' does not exist");var b=this._virtualMachines[a];return b.vm.destroy(),b.callback=void 0,delete this._virtualMachines[a],this},d.prototype.trigger=function(a){if(this._virtualMachines[a]){var b=this._virtualMachines[a].callback;b&&b(a,!0)}return this},d.prototype.destroy=function(){this._eventsTarget.addEventListener("keydown",this._eventsTargetCallback)};var e=function(a,b){if(this._markup=a,0==b.length)throw new Error("Keys nodes must be more, than one");this._keysNodes=b,this._currentKeysNodeIndex=0,this._lastCompleteTime=0,this.reset(),this.updateLastCompleteTime()};e.prototype.checkPressedKey=function(a){var b;return(b=this.testCurrentKeysNode(a))?this.moreThanOneNode&&this.currentKeysNode.finished&&(this.updateLastCompleteTime(),this._currentKeysNodeIndex++):this.reset(),b},e.prototype.reset=function(){this._currentKeysNodeIndex=0;for(var a=0;a<this._keysNodes.length;a++){var b=this._keysNodes[a];b.reset()}},e.prototype.testCurrentKeysNode=function(a){return this.currentKeysNode.checkPressedKey(a,this._lastCompleteTime)},e.prototype.updateLastCompleteTime=function(){this._lastCompleteTime=b()},e.prototype.__defineGetter__("finished",function(){return this._keysNodes[this._keysNodes.length-1].finished}),e.prototype.__defineGetter__("currentKeysNode",function(){return this._keysNodes[this._currentKeysNodeIndex]}),e.prototype.__defineGetter__("moreThanOneNode",function(){return this._keysNodes.length>1}),e.prototype.__defineGetter__("markup",function(){return this._markup}),e.prototype.toString=function(){return"HkmlVM{"+String(this._keysNodes)+"}"},e.prototype.destroy=function(){for(var a=0;a<this._keysNodes.length;a++)this._keysNodes[a].destroy();this._keysNodes=void 0};var f={},g=function(a,b,c){if(b=b||0,c=c||!1,this.existRepeatingKeyCodes(a))throw new Error("Keys must be unique in one instance of KeysNode");this._keys=a,this._delay=b,this._orMode=c,this._indexOfKeyToTest=0,c&&(this._keysStatus=new Array(a.length),this.resetKeyStatuses())};g.prototype.__defineGetter__("finished",function(){if(this._orMode){for(var a=0;a<this._keysStatus.length;a++){var b=this._keysStatus[a];if(!b)return!1}return!0}return this._keys.length==this._indexOfKeyToTest}),g.prototype.existRepeatingKeyCodes=function(a){for(var b=0;b<a.length-1;b++)if(-1!=a.indexOf(a[b],b+1))return!0;return!1},g.prototype.checkPressedKey=function(a,c){var d=b();if(0!=this._delay&&d-c>this._delay)return this.reset(),!1;var e;if(this._orMode){var f=this._keys.indexOf(a);if(-1==f)return this.reset(),!1;var g=this._keysStatus[f];if(g)return this.reset(),!1;this._keysStatus[f]=!0}else{if(e=this._keys[this._indexOfKeyToTest],a!=e)return this.reset(),!1;this._indexOfKeyToTest++}return!0},g.prototype.reset=function(){this._orMode?this.resetKeyStatuses():this._indexOfKeyToTest=0},g.prototype.resetKeyStatuses=function(){for(var a=0;a<this._keysStatus.length;a++)this._keysStatus[a]=!1},g.prototype.toString=function(){return"("+(this._delay>0?this._delay+":":"")+this._keys.join(this._orMode?"+":">>")+")"},g.prototype.destroy=function(){this._keys=this._keysStatus=void 0}}(0);