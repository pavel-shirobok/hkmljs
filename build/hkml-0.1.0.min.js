!function(){function a(a,b){this.constructor.prototype.__proto__=Error.prototype,Error.call(this),Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.message=a,this.indexOfMarkupErrorChar=b}function b(){return(new Date).getTime()}var c={TOKEN_KEY:"str",TOKEN_OR:"or",TOKEN_SEQ:"seq",SEQ:">",COMB:"+",SPACE:" ",TAB:"	",createToken:function(a,b,c){return{name:a,value:b,index:c}},compile:function(a){var b=c.tokenize(a),d=c.buildKeysNodes(b);return new e(a,d)},tokenize:function(b){var d,e,f="",g=[];for(d=0;d<b.length;d++)switch(e=b[d]){case c.SEQ:for(e=b[++d],f="";e!=c.SEQ;){if(d==b.length)throw new a("Unexpected end of line. Expected '>'",d-1);f+=e,e=b[++d]}if(0!=f.length){if(isNaN(parseInt(f))||parseInt(f)<=0)throw new a("Wrong delay value '"+f+"'",d-f.length-1)}else f="0";g.push(c.createToken(c.TOKEN_SEQ,f,d-f.length-1));break;case c.COMB:g.push(c.createToken(c.TOKEN_OR,e,d));break;case c.TAB:case c.SPACE:break;default:f="";do f+=e,e=b[++d];while(e!=c.SEQ&&e!=c.COMB&&e!=c.SPACE&&e!=c.TAB&&d!=b.length);g.push(c.createToken(c.TOKEN_KEY,f,d)),d--}return g},buildKeysNodes:function(b){for(var d,e,f,g,h=[],i=[],j=0,k=null,l=0;l<b.length;l++){if(d=b[l],e=d.name,f=d.value,g=d.index,0==l&&(e==c.TOKEN_OR||e==c.TOKEN_SEQ))throw new a("Line must be started by key",g);if(l==b.length-1&&(e==c.TOKEN_OR||e==c.TOKEN_SEQ))throw new a("Line must be ended by key",g);switch(e){case c.TOKEN_KEY:i.push(f);break;default:var m=parseFloat(f),n=0!=m&&!isNaN(m);if(null==k)n?(h.push(c.createKeysNode(i,e,j,d.index)),i=[],j=m):k=e;else if(k!=e||n){if(e==c.TOKEN_OR&&i.length>1){var o=i.pop();h.push(c.createKeysNode(i,k,j,d.index)),i=[o]}else h.push(c.createKeysNode(i,k,j,d.index)),i=[];j=m,k=n?null:e}else k=e}}return 0!=i.length&&h.push(c.createKeysNode(i,k,j,d.index)),h},createKeysNode:function(b,d,e,h){for(var i,j=new Array(b.length),k=0;k<b.length;k++){if(i=b[k],void 0==f[i])throw new a("Unknown key alias '"+i+"'",h);j[k]=f[i]}return new g(j,e,d==c.TOKEN_OR)}},d=function(a){this._eventsTarget=a||root,this._virtualMachines={},this.startKeyboardEventListening()};d.prototype.startKeyboardEventListening=function(){var a=this;this._eventsTargetCallback=function(b){a.onKeyDown(b)},this._eventsTarget.addEventListener("keydown",this._eventsTargetCallback)},d.prototype.onKeyDown=function(a){for(var b in this._virtualMachines){var c=this._virtualMachines[b],d=c.vm,e=c.callback;d.checkPressedKey(a.keyCode)?d.finished&&(d.reset(),e&&e(d.markup,!0)):(d.reset(),e&&e(d.markup,!1))}},d.prototype.on=function(a,b){if(this._virtualMachines[a])throw new Error("Handler for '"+a+"' already exist");return this._virtualMachines[a]={vm:c.compile(a),callback:b},this},d.prototype.remove=function(a){if(!this._virtualMachines[a])throw new Error("Handler for '"+a+"' does not exist");var b=this._virtualMachines[a];return b.vm.destroy(),b.callback=void 0,delete this._virtualMachines[a],this},d.prototype.trigger=function(a){if(this._virtualMachines[a]){var b=this._virtualMachines[a].callback;b&&b(a,!0)}return this},d.prototype.destroy=function(){this._eventsTarget.addEventListener("keydown",this._eventsTargetCallback)};var e=function(a,b){if(this._markup=a,0==b.length)throw new Error("Keys nodes must be more, than one");this._keysNodes=b,this._currentKeysNodeIndex=0,this._lastCompleteTime=0,this.reset(),this.updateLastCompleteTime()};e.prototype.checkPressedKey=function(a){var b;return(b=this.testCurrentKeysNode(a))?this.moreThanOneNode&&this.currentKeysNode.finished&&(this.updateLastCompleteTime(),this._currentKeysNodeIndex++):this.reset(),b},e.prototype.reset=function(){this._currentKeysNodeIndex=0;for(var a=0;a<this._keysNodes.length;a++){var b=this._keysNodes[a];b.reset()}},e.prototype.testCurrentKeysNode=function(a){return this.currentKeysNode.checkPressedKey(a,this._lastCompleteTime)},e.prototype.updateLastCompleteTime=function(){this._lastCompleteTime=b()},e.prototype.__defineGetter__("finished",function(){return this._keysNodes[this._keysNodes.length-1].finished}),e.prototype.__defineGetter__("currentKeysNode",function(){return this._keysNodes[this._currentKeysNodeIndex]}),e.prototype.__defineGetter__("moreThanOneNode",function(){return this._keysNodes.length>1}),e.prototype.__defineGetter__("markup",function(){return this._markup}),e.prototype.toString=function(){return"HkmlVM{"+String(this._keysNodes)+"}"},e.prototype.destroy=function(){for(var a=0;a<this._keysNodes.length;a++)this._keysNodes[a].destroy();this._keysNodes=void 0};var f={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,CANCEL:3,HELP:6,BACK_SPACE:8,TAB:9,CLEAR:12,ENTER:13,ENTER_SPECIAL:14,SHIFT:16,CONTROL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,KANA:21,EISU:22,JUNJA:23,FINAL:24,HANJA:25,ESCAPE:27,CONVERT:28,NONCONVERT:29,ACCEPT:30,MODECHANGE:31,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,SELECT:41,PRINT:42,EXECUTE:43,PRINTSCREEN:44,INSERT:45,DELETE:46,COLON:58,SEMICOLON:186,LESS_THAN:60,EQUALS:187,GREATER_THAN:62,QUESTION_MARK:63,AT:64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,WIN:91,CONTEXT_MENU:93,SLEEP:95,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SEPARATOR:108,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NUM_LOCK:144,SCROLL_LOCK:145,WIN_OEM_FJ_JISHO:146,WIN_OEM_FJ_MASSHOU:147,WIN_OEM_FJ_TOUROKU:148,WIN_OEM_FJ_LOYA:149,WIN_OEM_FJ_ROYA:150,CIRCUMFLEX:160,EXCLAMATION:161,DOUBLE_QUOTE:162,HASH:163,DOLLAR:164,PERCENT:165,AMPERSAND:166,UNDERSCORE:167,OPEN_PAREN:168,CLOSE_PAREN:169,ASTERISK:170,PLUS:171,PIPE:172,HYPHEN_MINUS:173,OPEN_CURLY_BRACKET:174,CLOSE_CURLY_BRACKET:175,TILDE:176,VOLUME_MUTE:181,VOLUME_DOWN:182,VOLUME_UP:183,COMMA:188,MINUS:189,PERIOD:190,SLASH:191,BACK_QUOTE:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,QUOTE:222,META:224,ALTGR:225,WIN_ICO_HELP:227,WIN_ICO_00:228,WIN_ICO_CLEAR:230,WIN_OEM_RESET:233,WIN_OEM_JUMP:234,WIN_OEM_PA1:235,WIN_OEM_PA2:236,WIN_OEM_PA3:237,WIN_OEM_WSCTRL:238,WIN_OEM_CUSEL:239,WIN_OEM_ATTN:240,WIN_OEM_FINISH:241,WIN_OEM_COPY:242,WIN_OEM_AUTO:243,WIN_OEM_ENLW:244,WIN_OEM_BACKTAB:245,ATTN:246,CRSEL:247,EXSEL:248,EREOF:249,PLAY:250,ZOOM:251,PA1:253,WIN_OEM_CLEAR:254},g=function(a,b,c){if(b=b||0,c=c||!1,this.existRepeatingKeyCodes(a))throw new Error("Keys must be unique in one instance of KeysNode");this._keys=a,this._delay=b,this._orMode=c,this._indexOfKeyToTest=0,c&&(this._keysStatus=new Array(a.length),this.resetKeyStatuses())};g.prototype.__defineGetter__("finished",function(){if(this._orMode){for(var a=0;a<this._keysStatus.length;a++){var b=this._keysStatus[a];if(!b)return!1}return!0}return this._keys.length==this._indexOfKeyToTest}),g.prototype.existRepeatingKeyCodes=function(a){for(var b=0;b<a.length-1;b++)if(-1!=a.indexOf(a[b],b+1))return!0;return!1},g.prototype.checkPressedKey=function(a,c){var d=b();if(0!=this._delay&&d-c>this._delay)return this.reset(),!1;var e;if(this._orMode){var f=this._keys.indexOf(a);if(-1==f)return this.reset(),!1;var g=this._keysStatus[f];if(g)return this.reset(),!1;this._keysStatus[f]=!0}else{if(e=this._keys[this._indexOfKeyToTest],a!=e)return this.reset(),!1;this._indexOfKeyToTest++}return!0},g.prototype.reset=function(){this._orMode?this.resetKeyStatuses():this._indexOfKeyToTest=0},g.prototype.resetKeyStatuses=function(){for(var a=0;a<this._keysStatus.length;a++)this._keysStatus[a]=!1},g.prototype.toString=function(){return"("+(this._delay>0?this._delay+":":"")+this._keys.join(this._orMode?"+":">>")+")"},g.prototype.destroy=function(){this._keys=this._keysStatus=void 0};var h=function(a){return new d(a)};h.HkmlVM=e,h.HkmlKeyboardController=d,h.HkmlCompiler=c,h.KeysNode=g,h.Keyboard=f,root.hkml=h}(0);