!function(){function a(a,b){this.constructor.prototype.__proto__=Error.prototype,Error.call(this),Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.message=a,this.indexOfMarkupErrorChar=b}function b(){return(new Date).getTime()}var c=function(a){return new e(a)};c.HkmlVM=f,c.HkmlKeyboardController=e,c.HkmlCompiler=d,c.KeysNode=h,c.Keyboard=g,root.hkml=c;var d={TOKEN_KEY:"str",TOKEN_OR:"or",TOKEN_SEQ:"seq",SEQ:">",COMB:"+",SPACE:" ",TAB:"	",createToken:function(a,b,c){return{name:a,value:b,index:c}},compile:function(a){var b=d.tokenize(a),c=d.buildKeysNodes(b);return new f(a,c)},tokenize:function(b){var c,e,f="",g=[];for(c=0;c<b.length;c++)switch(e=b[c]){case d.SEQ:for(e=b[++c],f="";e!=d.SEQ;){if(c==b.length)throw new a("Unexpected end of line. Expected '>'",c-1);f+=e,e=b[++c]}if(0!=f.length){if(isNaN(parseInt(f))||parseInt(f)<=0)throw new a("Wrong delay value '"+f+"'",c-f.length-1)}else f="0";g.push(d.createToken(d.TOKEN_SEQ,f,c-f.length-1));break;case d.COMB:g.push(d.createToken(d.TOKEN_OR,e,c));break;case d.TAB:case d.SPACE:break;default:f="";do f+=e,e=b[++c];while(e!=d.SEQ&&e!=d.COMB&&e!=d.SPACE&&e!=d.TAB&&c!=b.length);g.push(d.createToken(d.TOKEN_KEY,f,c)),c--}},buildKeysNodes:function(b){for(var c,e,f,g,h=[],i=[],j=0,k=null,l=0;l<b.length;l++){if(c=b[l],e=c.name,f=c.value,g=c.index,0==l&&(e==d.TOKEN_OR||e==d.TOKEN_SEQ))throw new a("Line must be started by key",g);if(l==b.length-1&&(e==d.TOKEN_OR||e==d.TOKEN_SEQ))throw new a("Line must be ended by key",g);switch(e){case d.TOKEN_KEY:i.push(f);break;default:var m=parseFloat(f),n=0!=m&&!isNaN(m);if(null==k)n?(h.push(d.createKeysNode(i,e,j,c.index)),i=[],j=m):k=e;else if(k!=e||n){if(e==d.TOKEN_OR&&i.length>1){var o=i.pop();h.push(d.createKeysNode(i,k,j,c.index)),i=[o]}else h.push(d.createKeysNode(i,k,j,c.index)),i=[];j=m,k=n?null:e}else k=e}}return 0!=i.length&&h.push(d.createKeysNode(i,k,j,c.index)),h},createKeysNode:function(b,c,e,f){for(var i,j=new Array(b.length),k=0;k<b.length;k++){if(i=b[k],void 0==g[i])throw new a("Unknown key alias '"+i+"'",f);j[k]=g[i]}return new h(j,e,c==d.TOKEN_OR)}},e=function(a){this._eventsTarget=a||root,this._virtualMachines={},this.startKeyboardEventListening()};e.prototype.startKeyboardEventListening=function(){var a=this;this._eventsTargetCallback=function(b){a.onKeyDown(b)},this._eventsTarget.addEventListener("keydown",this._eventsTargetCallback)},e.prototype.onKeyDown=function(a){for(var b in this._virtualMachines){var c=this._virtualMachines[b],d=c.vm,e=c.callback;d.checkPressedKey(a.keyCode)?d.finished&&(d.reset(),e&&e(d.markup,!0)):(d.reset(),e&&e(d.markup,!1))}},e.prototype.on=function(a,b){if(this._virtualMachines[a])throw new Error("Handler for '"+a+"' already exist");this._virtualMachines[a]={vm:d.compile(a),callback:b}},e.prototype.remove=function(a){if(!this._virtualMachines[a])throw new Error("Handler for '"+a+"' does not exist");var b=this._virtualMachines[a];return b.vm.destroy(),b.callback=void 0,delete this._virtualMachines[a],this},e.prototype.trigger=function(a){if(this._virtualMachines[a]){var b=this._virtualMachines[a].callback;b&&b(a,!0)}return this},e.prototype.destroy=function(){this._eventsTarget.addEventListener("keydown",this._eventsTargetCallback)};var f=function(a,b){if(this._markup=a,0==b.length)throw new Error("Keys nodes must be more, than one");this._keysNodes=b,this._currentKeysNodeIndex=0,this._lastCompleteTime=0,this.reset(),this.updateLastCompleteTime()};f.prototype.checkPressedKey=function(a){var b;return(b=this.testCurrentKeysNode(a))?this.moreThanOneNode&&this.currentKeysNode.finished&&(this.updateLastCompleteTime(),this._currentKeysNodeIndex++):this.reset(),b},f.prototype.reset=function(){this._currentKeysNodeIndex=0;for(var a=0;a<this._keysNodes.length;a++){var b=this._keysNodes[a];b.reset()}},f.prototype.testCurrentKeysNode=function(a){return this.currentKeysNode.checkPressedKey(a,this._lastCompleteTime)},f.prototype.updateLastCompleteTime=function(){this._lastCompleteTime=b()},f.prototype.__defineGetter__("finished",function(){return this._keysNodes[this._keysNodes.length-1].finished}),f.prototype.__defineGetter__("currentKeysNode",function(){return this._keysNodes[this._currentKeysNodeIndex]}),f.prototype.__defineGetter__("moreThanOneNode",function(){return this._keysNodes.length>1}),f.prototype.__defineGetter__("markup",function(){return this._markup}),f.prototype.toString=function(){return"HkmlVM{"+String(this._keysNodes)+"}"},f.prototype.destroy=function(){for(var a=0;a<this._keysNodes.length;a++)this._keysNodes[a].destroy();this._keysNodes=void 0};var g={},h=function(a,b,c){if(b=b||0,c=c||!1,this.existRepeatingKeyCodes(a))throw new Error("Keys must be unique in one instance of KeysNode");this._keys=a,this._delay=b,this._orMode=c,this._indexOfKeyToTest=0,c&&(this._keysStatus=new Array(a.length),this.resetKeyStatuses())};h.prototype.__defineGetter__("finished",function(){if(this._orMode){for(var a=0;a<this._keysStatus.length;a++){var b=this._keysStatus[a];if(!b)return!1}return!0}return this._keys.length==this._indexOfKeyToTest}),h.prototype.existRepeatingKeyCodes=function(a){for(var b=0;b<a.length-1;b++)if(-1!=a.indexOf(a[b],b+1))return!0;return!1},h.prototype.checkPressedKey=function(a,c){var d=b();if(0!=this._delay&&d-c>this._delay)return this.reset(),!1;var e;if(this._orMode){var f=this._keys.indexOf(a);if(-1==f)return this.reset(),!1;var g=this._keysStatus[f];if(g)return this.reset(),!1;this._keysStatus[f]=!0}else{if(e=this._keys[this._indexOfKeyToTest],a!=e)return this.reset(),!1;this._indexOfKeyToTest++}return!0},h.prototype.reset=function(){this._orMode?this.resetKeyStatuses():this._indexOfKeyToTest=0},h.prototype.resetKeyStatuses=function(){for(var a=0;a<this._keysStatus.length;a++)this._keysStatus[a]=!1},h.prototype.toString=function(){return"("+(this._delay>0?this._delay+":":"")+this._keys.join(this._orMode?"+":">>")+")"},h.prototype.destroy=function(){this._keys=this._keysStatus=void 0}}(0);